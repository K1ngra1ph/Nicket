<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' https://sandbox.sdk.monnify.com https://sdk.monnify.com;
    frame-src https://sandbox.sdk.monnify.com https://sdk.monnify.com https://sandbox.monnify.com https://sdk.monnify.com;
    connect-src 'self' https://nicket-backend.onrender.com https://sandbox.sdk.monnify.com https://sdk.monnify.com https://sandbox.monnify.com https://api.monnify.com https://api-sandbox.monnify.com;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
    font-src https://fonts.gstatic.com;
    img-src 'self' data:;
  ">
  <title>NICKET Games</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #fff9fc;
      --text: #1e293b;
      --accent: #2563eb;
      --accent-dark: #1e40af;
      --danger: #dc2626;
      --danger-dark: #b91c1c;
      --success: #16a34a;
      --card: #ffffff;
    }

    body.dark {
      --bg: #2c2c2c;
      --text: #e2e8f0;
      --accent: #3b82f6;
      --accent-dark: #1d4ed8;
      --danger: #ef4444;
      --danger-dark: #b91c1c;
      --success: #22c55e;
      --card: #1e293b;
    }

    body {
      font-family: "Poppins", sans-serif;
      background: var(--bg);
      padding: 30px;
      text-align: center;
      color: var(--text);
      transition: background 0.3s, color 0.3s;
    }

    .logo {
      position: fixed;
      top: 30px;
      left: 30px;
      width: 120px;
      height: auto;
      z-index: 2000;
    }

    #themeToggle {
      position: fixed;
      top: 20px;
      right: 25px;
      background: transparent;
      color: var(--accent-dark);
      border: 2px solid var(--accent-dark);
      border-radius: 20px;
      padding: 6px 12px;
      cursor: pointer;
      font-weight: 600;
      transition: 0.3s;
    }

    #themeToggle:hover {
      background: var(--accent);
      color: white;
    }

    #numberGrid {
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      gap: 10px;
      max-width: 600px;
      margin: 20px auto;
    }

    .number-box {
      width: 55px;
      height: 55px;
      border-radius: 8px;
      background: var(--accent);
      color: white;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: 0.2s;
    }

    .number-box:hover {
      background: var(--accent-dark);
      transform: scale(1.05);
    }

    .number-box.disabled {
      background: #9ca3af;
      cursor: not-allowed;
      transform: none;
    }

    #selectedNumbers {
      margin-top: 25px;
      padding: 15px;
      background: var(--card);
      border-radius: 10px;
      display: inline-block;
      min-width: 320px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    #selectedNumbers span {
      margin: 5px;
      background: var(--success);
      padding: 8px 12px;
      color: white;
      border-radius: 8px;
      font-weight: 600;
    }

    #totalValue {
      margin-top: 10px;
      font-weight: 600;
      color: var(--accent-dark);
    }

    #clearBtn, #submitBtn {
      margin-top: 20px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 25px;
      font-size: 16px;
      cursor: pointer;
      font-weight: 600;
      transition: 0.3s;
    }

    #clearBtn {
      background: var(--danger);
      margin-left: 10px;
    }

    #clearBtn:hover {
      background: var(--danger-dark);
    }

    #submitBtn:hover {
      background: var(--accent-dark);
    }

    /* Modal */
    #confirmModal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }

    .modal-content {
      background: var(--card);
      border-radius: 12px;
      padding: 25px;
      max-width: 420px;
      text-align: center;
      position: relative;
      color: var(--text);
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      animation: popIn 0.3s ease;
    }

    @keyframes popIn {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    .close-modal {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 20px;
      cursor: pointer;
    }
  </style>
</head>

<body>

  <img src="assets/images/nicket-logo.png" class="logo">

  <button id="themeToggle">ðŸŒ™</button>
  <p>Hi, <strong id="userName"></strong>!</p>

  <div id="numberGrid"></div>

  <div id="selectedNumbers">
    <strong>Your Selections:</strong>
    <div id="selectedList"></div>
    <div id="totalValue">Total: â‚¦0</div>
  </div>

  <button id="submitBtn">Let's GO!</button>
  <button id="clearBtn">Clear Picks</button>

  <!-- Confirmation Modal -->
  <div id="confirmModal">
    <div class="modal-content">
      <span class="close-modal" id="closeModalBtn">Ã—</span>
      <h3>Confirm your details</h3>
      <div id="confirmDetails" style="text-align:left;margin-top:10px;"></div>
      <button id="confirmPaymentBtn" style="background:#16a34a;color:white;margin-top:15px;padding:10px 18px;border:none;border-radius:6px;font-weight:600;">Confirm</button>
      <button id="cancelBtn" style="background:#dc2626;color:white;margin-left:10px;padding:10px 18px;border:none;border-radius:6px;font-weight:600;">Cancel</button>
    </div>
  </div>

<script>
/* ========= THEME ========= */
const themeToggle = document.getElementById("themeToggle");
themeToggle.addEventListener("click", () => {
  document.body.classList.toggle("dark");
  themeToggle.textContent = document.body.classList.contains("dark") ? "â˜€ï¸" : "ðŸŒ™";
});
if (localStorage.getItem("theme") === "dark") {
  document.body.classList.add("dark");
  themeToggle.textContent = "â˜€ï¸";
}

/* ========= USER DATA ========= */
const userData = JSON.parse(localStorage.getItem("userData") || "{}");
if (!userData.name) {
  alert("Please register first.");
  window.location.href = "index.html";
}
const { name, email, phone, eventValue } = userData;
document.getElementById("userName").textContent = name;

/* ========= GAME LOGIC ========= */
const grid = document.getElementById("numberGrid");
const selectedList = document.getElementById("selectedList");
const totalValueEl = document.getElementById("totalValue");
const numbers = Array.from({ length: 100 }, (_, i) => ({ number: i+1, globalCount: 0 }));
const selectedNumbers = [];

function renderGrid() {
  grid.innerHTML = "";
  numbers.forEach((item) => {
    const box = document.createElement("div");
    box.classList.add("number-box");
    box.textContent = item.number;

    if (item.globalCount >= 10) {
      box.classList.add("disabled");
    } else {
      box.addEventListener("click", () => handleSelect(item));
    }
    grid.appendChild(box);
  });
}

function handleSelect(item) {
  if (item.globalCount >= 10) return;
  selectedNumbers.push(item.number);
  item.globalCount++;
  updateSelectedList();
  renderGrid();
}

function updateSelectedList() {
  selectedList.innerHTML = "";
  selectedNumbers.forEach(num => {
    const tag = document.createElement("span");
    tag.textContent = num;
    selectedList.appendChild(tag);
  });
  totalValueEl.textContent = `Total: â‚¦${(selectedNumbers.length * 1000).toLocaleString()}`;
}

document.getElementById("clearBtn").addEventListener("click", () => {
  selectedNumbers.length = 0;
  numbers.forEach(n => n.globalCount = 0);
  updateSelectedList();
  renderGrid();
});

/* ========= MODAL ========= */
const confirmModal = document.getElementById("confirmModal");
document.getElementById("submitBtn").addEventListener("click", () => {
  if (selectedNumbers.length === 0) return alert("Select at least one number!");

  const total = selectedNumbers.length * 1000;
  document.getElementById("confirmDetails").innerHTML = `
    <p><strong>Name:</strong> ${name}</p>
    <p><strong>Email:</strong> ${email}</p>
    <p><strong>Phone:</strong> ${phone}</p>
    <p><strong>Event:</strong> ${eventValue}</p>
    <p><strong>Selected Numbers:</strong> ${selectedNumbers.join(", ")}</p>
    <p><strong>Total:</strong> â‚¦${total.toLocaleString()}</p>
  `;

  confirmModal.style.display = "flex";
});
document.getElementById("closeModalBtn").onclick =
document.getElementById("cancelBtn").onclick = () => confirmModal.style.display = "none";

/* ========= PAYMENT ========= */
function loadScript(src) {
  return new Promise((resolve, reject) => {
    if (document.querySelector(`script[src="${src}"]`)) {
      return resolve ();
    }
    const s = document.createElement('script');
    s.src = src;
    s.async = true;
    s.onload = () => resolve();
    s.onerror = () => reject(new Error ('Script load error: ' + src));
    document.head.appendChild(s);
  });
}
  
document.getElementById("confirmPaymentBtn").addEventListener("click", async () => {
  confirmModal.style.display = "none";

  const totalAmount = selectedNumbers.length * 1000;

  try {
    const res = await fetch("https://nicket-backend.onrender.com/api/payments/initiate-payment", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ name, email, phone, amount: totalAmount, eventValue })
    });

    if (!res.ok) {
      const txt = await res.text().catch(() => '');
      console.error('Backend non-OK response:', res.status, txt);
      throw new Error('Backend error');
    }

    const data = await res.json();

    if (!data.success) {
      console.error('Payment init failed', data);
      alert("Payment initialization failed: " + (data.error?.message || data.error || data.message || 'Unknown'));
      return;
    }

    const checkoutUrl = data.data?.checkoutUrl || data.data?.checkout_url || data.checkoutUrl || data.data?.checkouturl;
    if (checkoutUrl) {
      window.location.href = checkoutUrl;
      return;
    }

    const apiKey = data.data?.apiKey || data.data?.api_key;
    const paymentReference = data.data?.paymentReference || data.data?.payment_reference;
    const contractCode = data.contractCode || data.contract_code || data.data?.contractCode;

    if (!apiKey || !paymentReference || !contractCode) {
      console.error('Missing values for SDK flow', { apiKey, paymentReference, contractCode, data });
      alert("Payment initialization failed: missing configuration.");
      return;
    }

    await loadScript('https://sandbox.sdk.monnify.com/plugin/monnify.js');
    const isTestMode = typeof apiKey === 'string' && apiKey.startsWith('MK_TEST');

    if (!window.MonnifySDK || typeof window.MonnifySDK.initialize !== 'function') {
      console.error('Monnify SDK not available after load');
      alert('Payment service unavailable. Try again later.');
      return;
    }

    window.MonnifySDK.initialize({
      amount: totalAmount,
      currency: "NGN",
      reference: paymentReference,
      customerFullName: name || '',
      customerEmail: email || '',
      customerPhoneNumber: phone || '',
      apiKey,
      contractCode,
      paymentDescription: `Payment for Nicket Game - ${eventValue}`,
      isTestMode,
      metaData: { event: eventValue, selectedNumbers, playerName: name },
      
      onLoadStart: function() { console.log('Monnify SDK load started'); },
      onLoadComplete: function() { console.log('Monnify SDK load complete'); },
      
      onComplete: (response) => {
        if (response?.paymentStatus?.toLowerCase() === "paid") {
          alert("ðŸŽ‰ Payment Successful!");
          window.location.href = '/success.html';
        } else {
          alert("âŒ Payment Failed or Cancelled.");
          window.location.href = '/failed.html';
        }
      },
      onClose: () => console.log("Payment closed")
    });

  } catch (error) {
    console.error("Payment Error:", error);
    alert("Unable to initialize payment. Try again.");
  }
});

renderGrid();
</script>

</body>
</html>

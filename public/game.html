<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>NICKET | Live Game Session</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root { --bg:#fff9fc; --text:#1e293b; --accent:#2563eb; --accent-dark:#1e40af; --danger:#dc2626; --danger-dark:#b91c1c; --success:#16a34a; --card:#fff; --border:#e2e8f0; }
body.dark { --bg:#0f172a; --text:#f8fafc; --accent:#3b82f6; --accent-dark:#1d4ed8; --danger:#ef4444; --danger-dark:#b91c1c; --success:#22c55e; --card:#1e293b; --border:#334155; }

body { font-family:"Poppins",sans-serif; background:var(--bg); padding:20px; text-align:center; color:var(--text); transition:0.3s; margin:0; min-height:100vh; }

/* Fixed Logo Top-Left */
.logo { position: absolute; top: 25px; left: 25px; width: 100px; height: auto; z-index: 1001; }

/* Theme Toggle Top-Right */
#themeToggle { position:fixed; top:20px; right:20px; background:var(--card); color:var(--accent); border:2px solid var(--accent); border-radius:50%; width:45px; height:45px; cursor:pointer; font-size:20px; display:flex; align-items:center; justify-content:center; z-index:1000; transition:0.3s; }

/* Selection Grid */
#numberGrid { display:grid; grid-template-columns:repeat(auto-fit, minmax(55px, 1fr)); gap:10px; max-width:600px; margin:40px auto; padding:10px; }
.number-box { aspect-ratio: 1; border-radius:14px; background:var(--card); color:var(--text); border: 2px solid var(--border); font-weight:800; display:flex; flex-direction: column; align-items:center; justify-content:center; cursor:pointer; transition:0.2s; position: relative; }
.number-box:hover:not(.disabled) { border-color:var(--accent); transform:scale(1.05); }
.number-box.has-selections { border-color: var(--accent); color: var(--accent); background: rgba(37, 99, 235, 0.05); }
.number-box.disabled { background:#9ca3af; cursor:not-allowed; opacity: 0.3; filter: grayscale(1); }

/* Small badge inside grid for multiple picks */
.pick-count { position: absolute; top: -5px; right: -5px; background: var(--accent); color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

/* Selection Summary */
#selectedNumbers { margin-top:20px; padding:20px; background:var(--card); border-radius:24px; display:inline-block; min-width:320px; border:1px solid var(--border); box-shadow:0 10px 25px rgba(0,0,0,0.05); }
#selectedList span { margin:4px; display: inline-block; background:var(--accent); padding:6px 12px; color:white; border-radius:8px; font-weight:800; font-size: 14px; animation: popIn 0.3s ease; cursor: pointer; }
#selectedList span:hover { background: var(--danger); text-decoration: line-through; }

@keyframes popIn { from { transform:scale(0.8); opacity:0; } to { transform:scale(1); opacity:1; } }

#confirmModal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); backdrop-filter: blur(5px); justify-content:center; align-items:center; z-index:10000; }
.modal-content { background:var(--card); border-radius:32px; padding:30px; max-width:420px; width:90%; text-align:center; box-shadow:0 20px 40px rgba(0,0,0,0.3); animation: popIn 0.3s cubic-bezier(0.17, 0.89, 0.32, 1.49); }

#submitBtn { background:var(--accent); color:white; border:none; border-radius:16px; padding:18px 40px; font-size:18px; cursor:pointer; font-weight:800; transition:0.3s; width: 100%; max-width: 320px; margin-top: 20px; box-shadow: 0 10px 20px rgba(37, 99, 235, 0.2); }
#clearBtn { background:transparent; color:var(--text); border:1px solid var(--border); border-radius:12px; padding:10px 20px; cursor:pointer; margin-top: 15px; font-size: 12px; font-weight: 600; }

#loadingOverlay { position:fixed; inset:0; background:var(--bg); z-index:9999; display:flex; flex-direction:column; justify-content:center; align-items:center; }
.spinner { width:40px; height:40px; border:4px solid var(--border); border-top-color:var(--accent); border-radius:50%; animation:spin 1s linear infinite; margin-bottom: 10px; }
@keyframes spin { to { transform:rotate(360deg); } }
</style>
</head>
<body>

<div id="loadingOverlay">
    <div class="spinner"></div>
    <div style="font-weight: 800; letter-spacing: 2px;">SECURE CHANNEL INITIATING...</div>
</div>

<img src="assets/images/nicket-logo.png" class="logo" alt="Nicket">
<button id="themeToggle">ðŸŒ™</button>

<div style="margin-top: 60px;">
    <p style="font-weight: 600; opacity: 0.6; margin-bottom: 5px;">Player Session</p>
    <h1 id="userName" style="margin: 0; font-weight: 800; font-size: 24px;">Player</h1>
    <h2 id="currentEventName" style="margin: 10px 0 0; font-weight: 800; text-transform: uppercase; color: var(--accent); letter-spacing: 1px;">---</h2>
</div>

<div id="numberGrid"></div>

<div id="selectedNumbers">
  <p style="font-size: 12px; font-weight: 800; color: gray; margin-bottom: 10px; text-transform: uppercase;">Your Picks</p>
  <div id="selectedList"></div>
  <div id="totalValue" style="font-size: 28px; font-weight: 900; margin-top: 15px; color: var(--text);">â‚¦0</div>
  <button id="clearBtn">Clear My Picks</button>
</div>

<br>
<button id="submitBtn">CONFIRM & CHECKOUT</button>

<div id="confirmModal">
  <div class="modal-content">
    <h3 style="margin-top: 0; color:var(--accent); text-transform: uppercase; font-weight: 900;">CONFIRM PICKS</h3>
    <div id="confirmDetails" style="text-align:left; font-size: 14px; line-height: 1.8; margin: 20px 0; background: rgba(0,0,0,0.03); padding: 15px; border-radius: 15px;"></div>
    
    <div style="display: flex; gap: 10px;">
        <button id="confirmPaymentBtn" style="flex: 2; background:#2563eb; color:white; border:none; border-radius:15px; padding:16px; cursor:pointer; font-weight:800; text-transform: uppercase;">
          PROCEED
        </button>
        <button onclick="document.getElementById('confirmModal').style.display='none'" style="flex: 1; background:var(--card); color:var(--text); border:1px solid var(--border); border-radius:15px; cursor: pointer; font-weight: 700;">
          CANCEL
        </button>
    </div>
  </div>
</div>

<script>
const urlParams = new URLSearchParams(window.location.search);
const dynamicEventId = urlParams.get('event');
const API_BASE = "https://nicket-backend.onrender.com/api";
const MAX_TOTAL_SLOTS = 10;

localStorage.removeItem("selectedNumbers");

/* ===== THEME TOGGLE ===== */
const themeToggle = document.getElementById("themeToggle");
if (localStorage.getItem("theme") === "dark") document.body.classList.add("dark");
themeToggle.textContent = document.body.classList.contains("dark") ? "â˜€ï¸" : "ðŸŒ™";

themeToggle.onclick = () => {
  document.body.classList.toggle("dark");
  const isDark = document.body.classList.contains("dark");
  themeToggle.textContent = isDark ? "â˜€ï¸" : "ðŸŒ™";
  localStorage.setItem("theme", isDark ? "dark" : "light");
};

/* ===== STATE ===== */
const userData = JSON.parse(localStorage.getItem("userData") || "{}");
if (!userData.name || !dynamicEventId) { window.location.href = "/"; }

const { name, email, phone } = userData;
let TICKET_PRICE = 0;
let EVENT_NAME = "";
const selectedNumbers = [];
let backendLimits = {};

document.getElementById("userName").textContent = name;

/* ===== CORE FUNCTIONS ===== */
async function syncEventData() {
  try {
    const res = await fetch(`${API_BASE}/events`);
    const data = await res.json();
    const current = data.find(e => e._id === dynamicEventId);
    if (!current || !current.active) return window.location.href = "/";
    
    TICKET_PRICE = Number(current.price);
    EVENT_NAME = current.name;
    document.getElementById("currentEventName").textContent = EVENT_NAME;
  } catch (err) { console.error(err); }
}

async function loadBackendLimits() {
  try {
    const res = await fetch(`${API_BASE}/numbers/availability?eventId=${dynamicEventId}`);
    backendLimits = await res.json();
    renderGrid();
  } catch (err) { console.error(err); }
}

function renderGrid() {
  const grid = document.getElementById("numberGrid");
  grid.innerHTML = "";
  
  for (let i = 1; i <= 100; i++) {
    const localSelectionCount = selectedNumbers.filter(num => num === i).length;
    const backendCount = backendLimits[i] || 0;
    const totalCountForNumber = backendCount + localSelectionCount;
    const isSoldOut = totalCountForNumber >= MAX_TOTAL_SLOTS;
    const box = document.createElement("div");
    box.className = `number-box ${isSoldOut ? 'disabled' : ''} ${localSelectionCount > 0 ? 'has-selections' : ''}`;
    box.textContent = i;
    
    if (localSelectionCount > 0) {
        const badge = document.createElement("div");
        badge.className = "pick-count";
        badge.textContent = `x${localSelectionCount}`;
        box.appendChild(badge);
    }

    if (!isSoldOut) {
      box.onclick = () => addNumber(i);
    }
    grid.appendChild(box);
  }
}

function addNumber(num) {
  const localSelectionCount = selectedNumbers.filter(n => n === num).length;
  const backendCount = backendLimits[num] || 0;

  if (localSelectionCount + backendCount < MAX_TOTAL_SLOTS) {
    if (selectedNumbers.length >= 20) return alert("Maximum 20 entries per checkout.");
    selectedNumbers.push(num);
    updateUI();
  } else {
    alert("Number " + num + " is now fully booked!");
  }
}

function removeNumberAtIndex(index) {
    selectedNumbers.splice(index, 1);
    updateUI();
}

function updateUI() {
  const list = document.getElementById("selectedList");
  list.innerHTML = "";
  selectedNumbers.forEach((n, index) => {
      const span = document.createElement("span");
      span.textContent = n;
      span.title = "Click to remove";
      span.onclick = () => removeNumberAtIndex(index);
      list.appendChild(span);
  });

  const total = selectedNumbers.length * TICKET_PRICE;
  document.getElementById("totalValue").textContent = `â‚¦${total.toLocaleString()}`;
  renderGrid();
}

/* ===== ACTIONS ===== */
document.getElementById("clearBtn").onclick = () => {
    selectedNumbers.length = 0;
    updateUI();
};

document.getElementById("submitBtn").onclick = () => {
  if (!selectedNumbers.length) return alert("Please select at least one number to play!");
  const total = selectedNumbers.length * TICKET_PRICE;
  const displayNumbers = [...selectedNumbers].sort((a,b)=>a-b);

  document.getElementById("confirmDetails").innerHTML = `
    <div style="display:flex; justify-content:space-between"><span>NAME:</span> <b>${name}</b></div>
    <div style="display:flex; justify-content:space-between"><span>PRIZE:</span> <b>${EVENT_NAME}</b></div>
    <div style="display:flex; justify-content:space-between; margin-top:10px;"><span>ENTRIES:</span> <b>${selectedNumbers.length}</b></div>
    <div style="word-break: break-all; margin-top:5px; font-family:monospace; font-size:12px; color:gray;">${displayNumbers.join(', ')}</div>
    <hr style="opacity:0.1; margin:15px 0;">
    <div style="font-size: 20px; color: #2563eb; display:flex; justify-content:space-between"><span>TOTAL:</span> <b>â‚¦${total.toLocaleString()}</b></div>
  `;
  document.getElementById("confirmModal").style.display = "flex";
};

document.getElementById("confirmPaymentBtn").onclick = async () => {
  const btn = document.getElementById("confirmPaymentBtn");
  btn.disabled = true;
  btn.textContent = "SECURELY REDIRECTING...";
  
  try {
    const sanitizedNumbers = selectedNumbers.map(n => Number(n));

    const res = await fetch(`${API_BASE}/payments/initiate-payment`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ 
        name, email, phone, 
        amount: sanitizedNumbers.length * TICKET_PRICE, 
        eventValue: dynamicEventId, 
        eventName: EVENT_NAME,
        selectedNumbers: sanitizedNumbers
      })
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.message || "Request Failed");
    
    localStorage.removeItem("userData");
    window.location.href = data.checkoutUrl;
  } catch (err) {
    alert(err.message);
    btn.disabled = false;
    btn.textContent = "PROCEED TO PAY";
  }
};

/* ===== INIT ===== */
async function init() {
  await syncEventData();
  await loadBackendLimits();
  document.getElementById("loadingOverlay").style.display = "none";
  setInterval(loadBackendLimits, 15000);
}

init();
</script>
</body>
</html>
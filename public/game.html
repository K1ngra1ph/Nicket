<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Content-Security-Policy" content="
        default-src 'self'; 
        script-src 'self' 'unsafe-inline'; 
        connect-src 'self' https://nicket-backend.onrender.com https://api.monnify.com; 
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; 
        font-src https://fonts.gstatic.com; 
        img-src 'self' data:;
  ">
  <title>NICKET Games</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <img src="assets/images/nicket-logo.png" class="logo">
  <button id="themeToggle">ðŸŒ™</button>
  <p>Hi, <strong id="userName"></strong>!</p>

  <div id="numberGrid"></div>

  <div id="selectedNumbers">
    <strong>Your Selections:</strong>
    <div id="selectedList"></div>
    <div id="totalValue">Total: â‚¦0</div>
  </div>

  <button id="submitBtn">Let's GO!</button>
  <button id="clearBtn">Clear Picks</button>

  <!-- Confirmation Modal -->
  <div id="confirmModal">
    <div class="modal-content">
      <span class="close-modal" id="closeModalBtn">Ã—</span>
      <h3>Confirm your details</h3>
      <div id="confirmDetails" style="text-align:left;margin-top:10px;"></div>
      <button id="confirmPaymentBtn">Confirm</button>
      <button id="cancelBtn">Cancel</button>
    </div>
  </div>

  <!-- Payment Result Modal -->
  <div id="paymentResultModal">
    <div class="modal-content result-modal">
      <div id="paymentIcon"></div>
      <h2 id="paymentResultTitle"></h2>
      <p id="paymentResultMessage"></p>
      <div id="paymentResultButtons"></div>
    </div>
  </div>

  <script>
    /* ===== THEME ===== */
    const themeToggle = document.getElementById("themeToggle");
    themeToggle.addEventListener("click", () => {
      document.body.classList.toggle("dark");
      themeToggle.textContent = document.body.classList.contains("dark") ? "â˜€ï¸" : "ðŸŒ™";
      localStorage.setItem("theme", document.body.classList.contains("dark") ? "dark" : "light");
    });
    if (localStorage.getItem("theme") === "dark") document.body.classList.add("dark");

    /* ===== USER DATA ===== */
    const userData = JSON.parse(localStorage.getItem("userData") || "{}");
    if (!userData.name) { alert("Please register first."); window.location.href="/"; }
    const { name, email, phone, eventValue } = userData;
    document.getElementById("userName").textContent = name;

    /* ===== GAME LOGIC ===== */
    const grid = document.getElementById("numberGrid");
    const selectedList = document.getElementById("selectedList");
    const totalValueEl = document.getElementById("totalValue");
    const numbers = Array.from({ length: 100 }, (_, i) => ({ number: i+1, globalCount: 0 }));
    const selectedNumbers = [];

    function renderGrid() {
      grid.innerHTML = "";
      numbers.forEach(item => {
        const box = document.createElement("div");
        box.className = "number-box";
        box.textContent = item.number;
        if (item.globalCount >= 10) box.classList.add("disabled");
        else box.addEventListener("click", () => selectNumber(item));
        grid.appendChild(box);
      });
    }

    function selectNumber(item) {
      if (item.globalCount >= 10) return;
      selectedNumbers.push(item.number);
      item.globalCount++;
      updateSelectedList();
      renderGrid();
    }

    function updateSelectedList() {
      selectedList.innerHTML = "";
      selectedNumbers.forEach(n => { 
        const span = document.createElement("span"); 
        span.textContent = n; 
        selectedList.appendChild(span); 
      });
      totalValueEl.textContent = `Total: â‚¦${(selectedNumbers.length * 1000).toLocaleString()}`;
    }

    document.getElementById("clearBtn").addEventListener("click", () => {
      selectedNumbers.length = 0;
      numbers.forEach(n => n.globalCount = 0);
      updateSelectedList();
      renderGrid();
    });

    /* ===== MODAL ===== */
    const confirmModal = document.getElementById("confirmModal");
    const submitBtn = document.getElementById("submitBtn");
    submitBtn.addEventListener("click", () => {
      if (!selectedNumbers.length) return alert("Select at least one number!");
      document.getElementById("confirmDetails").innerHTML = `
        <p><strong>Name:</strong> ${name}</p>
        <p><strong>Email:</strong> ${email}</p>
        <p><strong>Phone:</strong> ${phone}</p>
        <p><strong>Event:</strong> ${eventValue}</p>
        <p><strong>Selected Numbers:</strong> ${selectedNumbers.join(", ")}</p>
        <p><strong>Total:</strong> â‚¦${(selectedNumbers.length*1000).toLocaleString()}</p>`;
      confirmModal.style.display = "flex";
    });
    document.getElementById("closeModalBtn").onclick =
    document.getElementById("cancelBtn").onclick = () => confirmModal.style.display = "none";

    /* ===== PAYMENT RESULT MODAL ===== */
    function showPaymentResult(success, message) {
      const modal = document.getElementById("paymentResultModal");
      const title = document.getElementById("paymentResultTitle");
      const msg = document.getElementById("paymentResultMessage");
      const buttonsDiv = document.getElementById("paymentResultButtons");
      const iconDiv = document.getElementById("paymentIcon");

      title.textContent = success ? "Payment Successful!" : "Payment Failed!";
      msg.textContent = message || "";

      iconDiv.innerHTML = success ? 'âœ…' : 'âŒ';
      iconDiv.style.color = success ? '#22c55e' : '#ef4444';

      buttonsDiv.innerHTML = "";
      if (success) {
        const okBtn = document.createElement("button");
        okBtn.textContent = "OK";
        okBtn.className = "success";
        okBtn.onclick = () => window.location.href = "/";
        buttonsDiv.appendChild(okBtn);
      } else {
        const tryBtn = document.createElement("button");
        tryBtn.textContent = "Try Again";
        tryBtn.className = "accent";
        tryBtn.onclick = () => { modal.style.display = "none"; submitBtn.click(); };

        const homeBtn = document.createElement("button");
        homeBtn.textContent = "Home";
        homeBtn.className = "danger";
        homeBtn.onclick = () => window.location.href = "/";

        buttonsDiv.appendChild(tryBtn);
        buttonsDiv.appendChild(homeBtn);
      }

      modal.style.display = "flex";
    }

    /* ===== CHECK FOR TRANSACTION AFTER REDIRECT ===== */
    window.addEventListener("DOMContentLoaded", async () => {
      const urlParams = new URLSearchParams(window.location.search);
      const transactionReference = urlParams.get("transactionReference");

      if (transactionReference) {
        try {
          const res = await fetch(`https://nicket-backend.onrender.com/api/payments/verify-payment?transactionReference=${encodeURIComponent(transactionReference)}`);
          if (!res.ok) throw new Error(`Backend error: ${res.status}`);
          const data = await res.json();
          if (!data.success) throw new Error(data.error?.message || "Payment verification failed");

          const info = data.data;
          const success = info.status === "SUCCESSFUL";
          const message = `
            Payment Reference: ${info.paymentReference}\n
            Amount Paid: â‚¦${(info.amountPaid || 0).toLocaleString()}\n
            Status: ${info.status}
          `;
          showPaymentResult(success, message);
          window.history.replaceState({}, document.title, window.location.pathname);
        } catch (err) {
          console.error("Verification error:", err);
          showPaymentResult(false, "Unable to verify payment. Try again.");
        }
      }
    });

    /* ===== PAYMENT ===== */
    document.getElementById("confirmPaymentBtn").addEventListener("click", async () => {
      confirmModal.style.display = "none";
      const totalAmount = selectedNumbers.length * 1000;

      try {
        const res = await fetch("https://nicket-backend.onrender.com/api/payments/initiate-payment", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, email, phone, amount: totalAmount, eventValue, selectedNumbers })
        });

        if (!res.ok) throw new Error(`Backend error: ${res.status}`);
        const data = await res.json();
        
        if (!data.checkoutUrl) {
          throw new Error("Missing checkout URL from backend");
        }
        window.location.href = data.checkoutUrl;
      } catch (err) {
        console.error("Payment error:", err);
        showPaymentResult(false, "Unable to initialize payment. Try again.");
      }
    });

    renderGrid();
  </script>
</body>
</html>

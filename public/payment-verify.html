<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Nicket | Verifying Entry...</title>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Albert+Sans:wght@400;600;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">

<style>
  :root {
    --brand-gold: #ffd700;
    --brand-red: #c1272d;
    --glass: rgba(30, 41, 59, 0.7);
  }

  body {
    margin: 0;
    height: 100vh;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    font-family: 'Albert Sans', sans-serif;
    background: #0f172a url("assets/images/backyii.jpg") no-repeat center center fixed;
    background-size: cover;
    color: #fff;
    overflow: hidden;
  }

  /* Overlay for background depth */
  body::before {
    content: '';
    position: absolute;
    inset: 0;
    background: radial-gradient(circle at center, transparent, rgba(15, 23, 42, 0.9));
    z-index: -1;
  }

  /* Main Loader Container */
  .loader-wrapper {
    text-align: center;
    z-index: 10;
  }

  .loader {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    border: 4px solid rgba(255, 255, 255, 0.1);
    border-top: 4px solid var(--brand-gold);
    animation: spin 1s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite;
    margin: 0 auto 20px;
    box-shadow: 0 0 20px rgba(255, 215, 0, 0.2);
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  /* Progress Bar */
  .progress-container {
    width: 200px;
    height: 6px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    margin: 15px auto;
    overflow: hidden;
  }

  .progress-fill {
    width: 0%;
    height: 100%;
    background: linear-gradient(90deg, var(--brand-red), var(--brand-gold));
    transition: width 0.5s ease;
  }

  .modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(12px);
    justify-content: center;
    align-items: center;
    z-index: 10001;
    padding: 20px;
  }

  .glass-card {
    background: var(--glass);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 32px;
    padding: 40px;
    max-width: 440px;
    width: 100%;
    text-align: center;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
    animation: slideUp 0.5s ease-out;
  }

  @keyframes slideUp {
    from { opacity: 0; transform: translateY(30px) scale(0.9); }
    to { opacity: 1; transform: translateY(0) scale(1); }
  }

  /* Ticket Box Styling */
  .ticket-box {
    background: rgba(15, 23, 42, 0.8);
    border: 2px dashed var(--brand-gold);
    padding: 20px;
    border-radius: 20px;
    margin: 25px 0;
    position: relative;
  }

  .ticket-label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 2px;
    color: var(--brand-gold);
    margin-bottom: 8px;
    display: block;
    opacity: 0.8;
  }

  .ticket-id {
    font-family: 'JetBrains Mono', monospace;
    font-size: 24px;
    font-weight: 800;
    color: #fff;
    display: block;
  }

  .copy-badge {
    background: var(--brand-gold);
    color: #000;
    font-size: 10px;
    font-weight: 800;
    padding: 4px 10px;
    border-radius: 20px;
    position: absolute;
    top: -12px;
    right: 20px;
    cursor: pointer;
    transition: 0.3s;
  }

  .copy-badge:hover { transform: scale(1.1); }

  /* Buttons */
  .btn-group { display: flex; flex-direction: column; gap: 12px; margin-top: 10px; }
  
  button {
    padding: 16px;
    border: none;
    border-radius: 16px;
    font-weight: 800;
    cursor: pointer;
    font-size: 15px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .btn-primary { background: var(--brand-gold); color: #000; box-shadow: 0 10px 15px -3px rgba(255, 215, 0, 0.3); }
  .btn-primary:hover { transform: translateY(-3px); box-shadow: 0 20px 25px -5px rgba(255, 215, 0, 0.4); }
  
  .btn-outline { background: rgba(255, 255, 255, 0.05); color: #fff; border: 1px solid rgba(255,255,255,0.1); }
  .btn-outline:hover { background: rgba(255, 255, 255, 0.1); }

  #statusText {
    font-size: 14px;
    color: #94a3b8;
    margin-top: 10px;
    min-height: 20px;
  }
</style>
</head>
<body>

<div class="loader-wrapper">
  <div class="loader"></div>
  <div style="font-weight: 600; letter-spacing: 1px;">NICKET SECURITY</div>
  <div id="statusText">Initiating bank verification...</div>
  <div class="progress-container">
    <div id="progressFill" class="progress-fill"></div>
  </div>
</div>

<!-- SUCCESS MODAL -->
<div id="successPaymentModal" class="modal">
  <div class="glass-card">
    <div style="font-size: 60px; margin-bottom: 10px;">üèÜ</div>
    <h2 style="margin: 0; font-size: 28px; font-weight: 800; color: var(--brand-gold);">YOU'RE IN!</h2>
    <p style="color: #94a3b8; font-size: 15px; margin-top: 8px;">Your payment has been fully verified.</p>
    
    <div class="ticket-box">
      <span class="copy-badge" onclick="copyTicketID()">Click to Copy</span>
      <span class="ticket-label">Receipt</span>
      <span id="displayTicketID" class="ticket-id">NICKET-XXXXX</span>
    </div>
    
    <div class="btn-group">
        <button onclick="window.location.href='index.html'" class="btn-primary">Home</button>
    </div>
  </div>
</div>

<!-- FAILURE MODAL -->
<div id="paymentResultModal" class="modal">
  <div class="glass-card">
    <div style="font-size: 60px; margin-bottom: 10px;">‚ö†Ô∏è</div>
    <h2 id="paymentResultTitle" style="color: #f87171; margin-top: 0;">Oops! Something happened</h2>
    <p id="paymentResultMessage" style="color: #94a3b8; font-size: 15px;"></p>
    
    <div class="btn-group">
        <button onclick="window.location.href='game.html'" class="btn-primary" style="background: #fff;">Try Again</button>
        <button onclick="window.location.href='index.html'" class="btn-outline">Home</button>
    </div>
  </div>
</div>

<script>
const API_BASE = "https://nicket-backend.onrender.com/api";

const loadingSteps = [
  "Connecting to secure payment gateway...",
  "Authenticating transaction reference...",
  "Waiting for bank confirmation...",
  "Updating entry ledger...",
  "Finalizing your Ticket ID...",
  "Almost there, securing connection..."
];

async function bridgeVerify() {
  const params = new URLSearchParams(window.location.search);
  const failedFlag = params.get("failed");
  let paymentReference = params.get("paymentReference");
  const transactionReference = params.get("transactionReference");

  if (failedFlag === "true") {
    showFailureModal("Transaction was cancelled or declined.");
    return;
  }

  if (!paymentReference && transactionReference) {
    try {
      const res = await fetch(`${API_BASE}/payments/get-payment-reference?transactionReference=${encodeURIComponent(transactionReference)}`);
      const data = await res.json();
      if (res.ok && data?.paymentReference) {
        paymentReference = data.paymentReference;
      }
    } catch (err) { console.error("Reference Error:", err); }
  }

  if (!paymentReference) {
    showFailureModal("We couldn't find your payment reference. Contact support if debited.");
    return;
  }

  let attempts = 0, maxAttempts = 15;
  const progressFill = document.getElementById("progressFill");
  const statusText = document.getElementById("statusText");

  while (attempts < maxAttempts) {
    const progress = (attempts / maxAttempts) * 100;
    progressFill.style.width = `${progress}%`;
    statusText.textContent = loadingSteps[attempts % loadingSteps.length];

    try {
      const response = await fetch(`${API_BASE}/payments/verify/${paymentReference}`);
      const data = await response.json();

      if (response.ok) {
        const status = (data.status || data.paymentStatus || "").toLowerCase();
        
        if (status === "paid" || status === "successful") {
          progressFill.style.width = `100%`;
          setTimeout(() => showSuccessModal(paymentReference), 500);
          return;
        } else if (status === "failed") {
          showFailureModal("The bank reported a failure with this transaction.");
          return;
        }
      }
    } catch(err) { console.error("Poll Error:", err); }
    
    attempts++;
    await new Promise(r => setTimeout(r, 2000));
  }

  showFailureModal("Verification is taking longer than usual. Please save this reference and check back: " + paymentReference);
}

function showSuccessModal(ref) {
  document.querySelector(".loader-wrapper").style.display = "none";
  
  const modal = document.getElementById("successPaymentModal");
  document.getElementById("displayTicketID").textContent = ref; 
  modal.style.display = "flex";

  const duration = 3 * 1000;
  const end = Date.now() + duration;

  (function frame() {
    confetti({
      particleCount: 3,
      angle: 60,
      spread: 55,
      origin: { x: 0 },
      colors: ['#ffd700', '#c1272d']
    });
    confetti({
      particleCount: 3,
      angle: 120,
      spread: 55,
      origin: { x: 1 },
      colors: ['#ffd700', '#c1272d']
    });

    if (Date.now() < end) {
      requestAnimationFrame(frame);
    }
  }());
}

function showFailureModal(message) {
  document.querySelector(".loader-wrapper").style.display = "none";
  const modal = document.getElementById("paymentResultModal");
  document.getElementById("paymentResultMessage").textContent = message;
  modal.style.display = "flex";
}

function copyTicketID() {
  const text = document.getElementById("displayTicketID").textContent;
  const badge = document.querySelector(".copy-badge");
  navigator.clipboard.writeText(text).then(() => {
    badge.textContent = "Copied!";
    badge.style.background = "#22c55e";
    badge.style.color = "#fff";
    setTimeout(() => {
      badge.textContent = "Click to Copy";
      badge.style.background = "var(--brand-gold)";
      badge.style.color = "#000";
    }, 2000);
  });
}

document.addEventListener("DOMContentLoaded", bridgeVerify);
</script>
</body>
</html>